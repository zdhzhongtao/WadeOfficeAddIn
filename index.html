<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Excelæ•°æ®å·¥å…·</title>
    <script
      type="text/javascript"
      src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"
    ></script>
    <style>
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        margin: 0;
        padding: 20px;
        color: #333;
        background-color: #f8f9fa;
      }
      .container {
        max-width: 600px;
        margin: 0 auto;
        background: white;
        padding: 25px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      h1 {
        color: #1e6f5c;
        margin-top: 0;
        font-size: 24px;
        text-align: center;
      }
      .instructions {
        background-color: #e8f4f0;
        padding: 15px;
        border-radius: 5px;
        margin-bottom: 20px;
        font-size: 14px;
        line-height: 1.5;
      }
      .step {
        margin-bottom: 8px;
      }
      .step-number {
        display: inline-block;
        width: 24px;
        height: 24px;
        background: #1e6f5c;
        color: white;
        text-align: center;
        line-height: 24px;
        border-radius: 50%;
        margin-right: 8px;
        font-size: 14px;
      }
      .button-container {
        display: flex;
        flex-direction: column;
        gap: 12px;
        margin-top: 15px;
      }
      .quiz-button {
        display: flex;
        align-items: center;
        border: none;
        padding: 15px 20px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 16px;
        width: 100%;
        transition: all 0.3s ease;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        text-align: left;
        color: white;
        font-weight: 600;
        background: linear-gradient(90deg, var(--start-color), var(--end-color));
        /* width: fit-content;
        min-width: 50%; */
      }
      .quiz-button:hover {
        box-shadow: 0 8px 15px rgba(0, 0, 0, 0.2);
        transform: translateY(-2px);
      }
      .quiz-button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }
      .button-icon {
        margin-right: 12px;
        font-size: 20px;
        /* filter: brightness(0) invert(1); */
      }
      /* ç‰¹å®šæŒ‰é’®é¢œè‰² - ä½¿ç”¨æ¸å˜ */
      .button-pink {
        --start-color: #FF6B8B;
        --end-color: #FFA3B4;
      }
      .button-purple {
        --start-color: #9C56B5;
        --end-color: #5E72E4;
      }
      .button-cyan {
        --start-color: #4ECDC4;
        --end-color: #A5E6BA;
      }
      .button-orange {
        --start-color: #FF9F43;
        --end-color: #FFD26F;
      }
      .status {
        margin-top: 15px;
        padding: 10px;
        border-radius: 5px;
        display: none;
      }
      .success {
        background-color: #e8f5e9;
        color: #2e7d32;
        border: 1px solid #c8e6c9;
      }
      .error {
        background-color: #ffebee;
        color: #c62828;
        border: 1px solid #ffcdd2;
      }
      .loading {
        text-align: center;
        margin: 20px 0;
        display: none;
      }
      .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #1e6f5c;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        animation: spin 1s linear infinite;
        margin: 0 auto;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      .tooltip {
        position: relative;
        display: inline-block;
      }
      .tooltip .tooltiptext {
        visibility: hidden;
        width: 250px;
        background-color: #555;
        color: #fff;
        text-align: center;
        border-radius: 6px;
        padding: 10px;
        position: absolute;
        z-index: 1;
        bottom: 125%;
        left: 50%;
        margin-left: -125px;
        opacity: 0;
        transition: opacity 0.3s;
        font-size: 13px;
        line-height: 1.4;
        text-align: left;
      }
      .tooltip:hover .tooltiptext {
        visibility: visible;
        opacity: 1;
      }
    </style>
  </head>

  <body>
    <div class="container">
      <h1>Excelæ•°æ®å·¥å…·</h1>

      <div class="instructions">
        <div class="step">
          <span class="step-number">1</span>åœ¨Excelä¸­é€‰æ‹©ä¸¤åˆ—æ•°æ®ï¼ˆå¦‚Aåˆ—å’ŒBåˆ—ï¼‰
        </div>
        <div class="step">
          <span class="step-number">2</span>ç‚¹å‡»ä¸‹é¢çš„æŒ‰é’®è¿›è¡Œæ¯”è¾ƒ
        </div>
        <div class="step">
          <span class="step-number">3</span>å·¥å…·å°†åˆ›å»ºæ–°å·¥ä½œè¡¨æ˜¾ç¤ºå·®å¼‚ç»“æœ
        </div>
      </div>

      <div class="button-container">
        <div class="tooltip">
          <button id="compareButton" class="quiz-button button-pink">
            <span class="button-icon">ğŸ”</span>
            æ¯”è¾ƒä¸¤åˆ—æ•°æ®
          </button>
          <span class="tooltiptext">
            æ“ä½œæ­¥éª¤:<br />
            1. åœ¨Excelä¸­é€‰æ‹©ä¸¤åˆ—æ•°æ®ï¼ˆå¦‚Aåˆ—å’ŒBåˆ—ï¼‰<br />
            2. ç‚¹å‡»æ­¤æŒ‰é’®è¿›è¡Œæ¯”è¾ƒ<br />
            3. å·¥å…·å°†åˆ›å»ºæ–°å·¥ä½œè¡¨æ˜¾ç¤ºå·®å¼‚ç»“æœ
          </span>
        </div>

        <div class="tooltip">
          <button id="clearButton" class="quiz-button button-purple">
            <span class="button-icon">ğŸ’¡</span>
            æ¸…ç©ºå½“å‰å·¥ä½œè¡¨æ•°æ®
          </button>
          <span class="tooltiptext">
            æ“ä½œæ­¥éª¤:<br />
            1. ç¡®ä¿æ‚¨åœ¨å½“å‰è¦æ¸…ç©ºçš„å·¥ä½œè¡¨ä¸­<br />
            2. ç‚¹å‡»æ­¤æŒ‰é’®æ¸…ç©ºæ‰€æœ‰æ•°æ®<br />
            3. æ³¨æ„: æ­¤æ“ä½œä¸å¯æ’¤é”€ï¼Œè¯·è°¨æ…ä½¿ç”¨
          </span>
        </div>

        <!-- æ–°å¢çš„ä¸¤ä¸ªTODOæŒ‰é’® -->
        <div class="tooltip">
          <button class="quiz-button button-cyan" disabled>
            <span class="button-icon">âœï¸</span>
            æŒ‰åˆ—æ‹†åˆ†æˆå¤šä¸ªsheetè¡¨
          </button>
          <span class="tooltiptext">
            æ­¤åŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­ï¼Œæ•¬è¯·æœŸå¾…...
          </span>
        </div>

        <div class="tooltip">
          <button class="quiz-button button-orange" disabled>
            <span class="button-icon">ğŸ†</span>
            æå–èº«ä»½è¯ç”Ÿæ—¥å’Œå¹´é¾„
          </span>
          <span class="tooltiptext">
            æ­¤åŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­ï¼Œæ•¬è¯·æœŸå¾…...
          </span>
        </div>
      </div>

      <div class="loading">
        <div class="spinner"></div>
        <p>å¤„ç†ä¸­ï¼Œè¯·ç¨å€™...</p>
      </div>

      <div id="statusMessage" class="status"></div>
    </div>
    <!-- <script src="addin.js"></script> -->
    <script>
      Office.onReady((info) => {
        if (info.host === Office.HostType.Excel) {
          document.getElementById("compareButton").onclick = compareColumns;
          document.getElementById("clearButton").onclick = clearWorksheet;
        }
      });

      async function compareColumns(event) {
        const button = document.getElementById("compareButton");
        const statusMessage = document.getElementById("statusMessage");
        const loading = document.querySelector(".loading");

        // é‡ç½®çŠ¶æ€ä¿¡æ¯
        statusMessage.style.display = "none";
        statusMessage.className = "status";
        button.disabled = true;
        loading.style.display = "block";

        try {
          await Excel.run(async (context) => {
            // è·å–å½“å‰é€‰å®šçš„èŒƒå›´
            const range = context.workbook.getSelectedRange();
            range.load("columnCount, columnIndex, address, values");

            await context.sync();

            // æ£€æŸ¥æ˜¯å¦é€‰ä¸­äº†ä¸¤åˆ—
            if (range.columnCount !== 2) {
              throw new Error(
                "è¯·é€‰æ‹©æ°å¥½ä¸¤åˆ—æ•°æ®è¿›è¡Œæ¯”è¾ƒã€‚æ‚¨å½“å‰é€‰æ‹©äº† " +
                  range.columnCount +
                  " åˆ—ã€‚"
              );
            }

            // è·å–ä¸¤åˆ—æ•°æ®
            const columnA = [];
            const columnB = [];

            for (let i = 0; i < range.values.length; i++) {
              if (
                range.values[i][0] !== undefined &&
                range.values[i][0] !== null &&
                range.values[i][0] !== ""
              ) {
                columnA.push(range.values[i][0]);
              }
              if (
                range.values[i][1] !== undefined &&
                range.values[i][1] !== null &&
                range.values[i][1] !== ""
              ) {
                columnB.push(range.values[i][1]);
              }
            }

            // æ‰¾å‡ºå·®å¼‚æ•°æ®
            const inANotInB = columnA.filter((item) => !columnB.includes(item));
            const inBNotInA = columnB.filter((item) => !columnA.includes(item));

            // è·å–å½“å‰å·¥ä½œè¡¨åç§°ç”¨äºå¼•ç”¨
            const originalSheet =
              context.workbook.worksheets.getActiveWorksheet();
            originalSheet.load("name");
            await context.sync();

            // åˆ›å»ºæ–°å·¥ä½œè¡¨
            const newSheetName =
              "æ¯”è¾ƒç»“æœ_" + new Date().getTime().toString().slice(-4);
            const newSheet = context.workbook.worksheets.add(newSheetName);

            // è®¾ç½®æ ‡é¢˜
            newSheet.getRange("A1").values = [["Aåˆ—æœ‰ä½†Båˆ—æ²¡æœ‰çš„æ•°æ®"]];
            newSheet.getRange("B1").values = [["Båˆ—æœ‰ä½†Aåˆ—æ²¡æœ‰çš„æ•°æ®"]];

            // è®¾ç½®æ ‡é¢˜æ ·å¼
            newSheet.getRange("A1:B1").format.fill.color = "#e8f4f0";
            newSheet.getRange("A1:B1").format.font.bold = true;

            // å¡«å……æ•°æ®
            const maxLength = Math.max(inANotInB.length, inBNotInA.length);
            for (let i = 0; i < maxLength; i++) {
              if (i < inANotInB.length) {
                newSheet.getRange(`A${i + 2}`).values = [[inANotInB[i]]];
              }
              if (i < inBNotInA.length) {
                newSheet.getRange(`B${i + 2}`).values = [[inBNotInA[i]]];
              }
            }

            // è‡ªåŠ¨è°ƒæ•´åˆ—å®½
            newSheet.getUsedRange().format.autofitColumns();

            // æ·»åŠ æŒ‡å‘åŸå§‹æ•°æ®çš„å¼•ç”¨
            const originalRangeAddress = range.address;
            const originalSheetName = originalSheet.name;

            newSheet.getRange("D1").values = [
              [`æ•°æ®æ¥æº: ${originalSheetName}!${originalRangeAddress}`],
            ];
            newSheet.getRange("D1").format.font.size = 10;
            newSheet.getRange("D1").format.font.color = "#666666";

            // æ¿€æ´»æ–°å·¥ä½œè¡¨
            newSheet.activate();

            await context.sync();

            // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
            showStatus(
              `æˆåŠŸåˆ›å»ºæ¯”è¾ƒç»“æœï¼æ‰¾åˆ° ${inANotInB.length} ä¸ªAåˆ—ç‹¬æœ‰é¡¹å’Œ ${inBNotInA.length} ä¸ªBåˆ—ç‹¬æœ‰é¡¹ã€‚`,
              "success"
            );
          });
        } catch (error) {
          console.error(error);
          showStatus("é”™è¯¯: " + error.message, "error");
        } finally {
          button.disabled = false;
          loading.style.display = "none";
          event || event.completed();
        }
      }

      async function clearWorksheet(event) {
        const button = document.getElementById("clearButton");
        const statusMessage = document.getElementById("statusMessage");
        const loading = document.querySelector(".loading");

        // é‡ç½®çŠ¶æ€ä¿¡æ¯
        statusMessage.style.display = "none";
        statusMessage.className = "status";
        button.disabled = true;
        loading.style.display = "block";

        try {
          await Excel.run(async (context) => {
            // è·å–å½“å‰æ´»åŠ¨å·¥ä½œè¡¨
            const sheet = context.workbook.worksheets.getActiveWorksheet();

            // æ¸…ç©ºæ‰€æœ‰å•å…ƒæ ¼å†…å®¹[1,2](@ref)
            sheet.getUsedRange().clear();

            await context.sync();

            // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
            showStatus("å·¥ä½œè¡¨å·²æˆåŠŸæ¸…ç©ºï¼", "success");
          });
        } catch (error) {
          console.error(error);
          showStatus("é”™è¯¯: " + error.message, "error");
        } finally {
          button.disabled = false;
          loading.style.display = "none";
          event || event.completed();
        }
      }

      function showStatus(message, type) {
        const statusMessage = document.getElementById("statusMessage");
        statusMessage.textContent = message;
        statusMessage.className = "status " + type;
        statusMessage.style.display = "block";
      }

      Office.actions.associate("groupCompareColumns", compareColumns);
      Office.actions.associate("groupClearWorksheet", clearWorksheet);
    </script>
  </body>
</html>